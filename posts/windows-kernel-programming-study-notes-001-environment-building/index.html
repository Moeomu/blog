<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This time is to learn from scratch again, before learning the kernel some unsystematic, this time must systematically organize the content of the Windows kernel programming again"><title>Windows Kernel Programming Study Notes 001 Environment Building</title><link rel=canonical href=https://blog.moeomu.com/posts/windows-kernel-programming-study-notes-001-environment-building/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Windows Kernel Programming Study Notes 001 Environment Building"><meta property="og:description" content="This time is to learn from scratch again, before learning the kernel some unsystematic, this time must systematically organize the content of the Windows kernel programming again"><meta property="og:url" content="https://blog.moeomu.com/posts/windows-kernel-programming-study-notes-001-environment-building/"><meta property="og:site_name" content="Misaka's Secrect Garden"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Kernel"><meta property="article:published_time" content="2020-12-18T18:52:00+08:00"><meta property="article:modified_time" content="2020-12-18T18:52:00+08:00"><meta name=twitter:title content="Windows Kernel Programming Study Notes 001 Environment Building"><meta name=twitter:description content="This time is to learn from scratch again, before learning the kernel some unsystematic, this time must systematically organize the content of the Windows kernel programming again"><script async src=https://umami.moeomu.com/Prototype data-website-id=da63d88b-4c19-4ee6-93cc-e12bd941eb81></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu5c4b01d6d06a4818a5284ca6e51e5ac9_24136_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Misaka's Secrect Garden</a></h1><h2 class=site-description>In the gardens embrace, a celestial sprite dances.</h2></div></header><ol class=social-menu><li><a href=https://github.com/Misakaou target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/comment/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>Comment</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://blog.moeomu.com/ selected>English</option><option value=https://blog.moeomu.com/zh-cn/>‰∏≠Êñá</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#windows-kernel-development-environment-configuration>Windows kernel development environment configuration</a><ol><li><a href=#download>Download</a></li><li><a href=#test-driver>Test driver</a></li><li><a href=#test-debugging>Test debugging</a></li></ol></li><li><a href=#contextual-environment-analysis>Contextual environment analysis</a><ol><li><a href=#experiment-psgetcurrentprocessid>Experiment: PsGetCurrentProcessId</a></li><li><a href=#conclusion>Conclusion</a></li></ol></li><li><a href=#interrupt-request-level>Interrupt request level</a><ol><li><a href=#table-of-common-irql-interrupt-request-levels>Table of common IRQL interrupt request levels</a></li><li><a href=#determine-the-current-irql>Determine the current IRQL</a></li><li><a href=#conclusion-1>Conclusion</a></li></ol></li><li><a href=#driver-exceptions>Driver exceptions</a><ol><li><a href=#common-causes>Common causes</a></li><li><a href=#active-blue-screen-triggered>Active blue screen triggered</a></li><li><a href=#conclusion-2>Conclusion</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/kernelprogramming/>KernelProgramming</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/windows-kernel-programming-study-notes-001-environment-building/>Windows Kernel Programming Study Notes 001 Environment Building</a></h2><h3 class=article-subtitle>This time is to learn from scratch again, before learning the kernel some unsystematic, this time must systematically organize the content of the Windows kernel programming again</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 18, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ class=link>‰∏≠Êñá</a></div></footer></div></header><section class=article-content><p>Source: <a class=link href=/posts/windows-kernel-programming-study-notes-001-environment-building/>Moeomu&rsquo;s blog</a></p><h2 id=windows-kernel-development-environment-configuration>Windows kernel development environment configuration</h2><h3 id=download>Download</h3><blockquote><p>Development Machine</p></blockquote><ul><li>Windows 10 20H2 x64</li><li>Visual Studio 2019</li><li>Windows Driver Kit - Windows 10.0.19041.685 (Windows 10 2004)</li><li>WinDbg Preview</li></ul><blockquote><p>Test Machine</p></blockquote><ul><li>Windows 10 2004 x64</li><li>DbgView</li></ul><h3 id=test-driver>Test driver</h3><blockquote><p>Let&rsquo;s start with the classic HelloWorld</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ntddk.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>VOID</span> <span class=nf>DriverUnload</span><span class=p>(</span><span class=n>PDRIVER_OBJECT</span> <span class=n>DriverObject</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Unload, Driver Object Address: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>DriverObject</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NTSTATUS</span> <span class=nf>DriverEntry</span><span class=p>(</span><span class=n>PDRIVER_OBJECT</span> <span class=n>DriverObject</span><span class=p>,</span> <span class=n>PUNICODE_STRING</span> <span class=n>RegistryPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Hello Kernel World!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>DriverObject</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Object Address: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>DriverObject</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>DriverObject</span><span class=o>-&gt;</span><span class=n>DriverUnload</span> <span class=o>=</span> <span class=n>DriverUnload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>RegistryPath</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Registry Path: %wZ</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>RegistryPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>STATUS_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=test-debugging>Test debugging</h3><blockquote><p>Refer to <a class=link href=/posts/Windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/>Windows kernel debugging</a> article to set up the debugging environment, except that the place of Windows 7 can be changed to Windows 10</p></blockquote><h2 id=contextual-environment-analysis>Contextual environment analysis</h2><blockquote><p>Context refers to the environment and state that the CPU is in when executing the code and changing the code.</p></blockquote><h3 id=experiment-psgetcurrentprocessid>Experiment: PsGetCurrentProcessId</h3><blockquote><p>The purpose of the experiment is to find out in which &ldquo;process&rdquo; the written driver module is executed</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ntddk.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>VOID</span> <span class=nf>DriverUnload</span><span class=p>(</span><span class=n>PDRIVER_OBJECT</span> <span class=n>DriverObject</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Unload, Driver Object Address: %p, Current Process Id=0x%p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>DriverObject</span><span class=p>,</span> <span class=nf>PsGetCurrentProcessId</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NTSTATUS</span> <span class=nf>DriverEntry</span><span class=p>(</span><span class=n>PDRIVER_OBJECT</span> <span class=n>DriverObject</span><span class=p>,</span> <span class=n>PUNICODE_STRING</span> <span class=n>RegistryPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Hello Kernel World, Current Process Id=0x%p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=nf>PsGetCurrentProcessId</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>DriverObject</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Object Address: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>DriverObject</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>DriverObject</span><span class=o>-&gt;</span><span class=n>DriverUnload</span> <span class=o>=</span> <span class=n>DriverUnload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>RegistryPath</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>DbgPrint</span><span class=p>(</span><span class=s>&#34;[%ws] Driver Registry Path: %wZ</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTIONW__</span><span class=p>,</span> <span class=n>RegistryPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>STATUS_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>As shown</li></ul><p><img src=/posts/windows-kernel-programming-study-notes-001-environment-building/shown1.png width=1161 height=477 srcset="/posts/windows-kernel-programming-study-notes-001-environment-building/shown1_hu56feb903f34a6c562b078d24280841de_92241_480x0_resize_box_3.png 480w, /posts/windows-kernel-programming-study-notes-001-environment-building/shown1_hu56feb903f34a6c562b078d24280841de_92241_1024x0_resize_box_3.png 1024w" loading=lazy alt=rYh5BF.png class=gallery-image data-flex-grow=243 data-flex-basis=584px>
<img src=/posts/windows-kernel-programming-study-notes-001-environment-building/shown2.png width=829 height=208 srcset="/posts/windows-kernel-programming-study-notes-001-environment-building/shown2_huaf36572bc8d9ea9a3ec9f5032d2b20c5_23447_480x0_resize_box_3.png 480w, /posts/windows-kernel-programming-study-notes-001-environment-building/shown2_huaf36572bc8d9ea9a3ec9f5032d2b20c5_23447_1024x0_resize_box_3.png 1024w" loading=lazy alt=rYhq91.png class=gallery-image data-flex-grow=398 data-flex-basis=956px></p><h3 id=conclusion>Conclusion</h3><blockquote><p>Both the driver entry function and the driver uninstall callback function belong to the process with ID 4, and this process is the System process</p></blockquote><ul><li>System process is a process virtualized by the operating system, representing the system kernel</li><li>If process A is running in P1 virtual space and the current CPU context of the driver is P2 virtual space, then the accessed content should be unpredictable</li></ul><h2 id=interrupt-request-level>Interrupt request level</h2><blockquote><p>Similar to the concept of priority of threads, the system scheduler schedules threads at the granularity of time slice, based on their priority, the higher the thread priority, the higher the chance of getting scheduled. And at the driver level, the CPU provides the concept of IRQL, which stipulates that code at high IRQL level can interrupt and preempt the execution process of code at low IRQL to execute.</p></blockquote><h3 id=table-of-common-irql-interrupt-request-levels>Table of common IRQL interrupt request levels</h3><div class=table-wrapper><table><thead><tr><th>IRQL</th><th>Value(x86, amd64, IA64)</th><th>Description</th></tr></thead><tbody><tr><td>PASSIVE_LEVEL</td><td>0, 0, 0</td><td>Application layer threads and most kernel functions are in this IRQL, with unlimited access to all kernel APIs, paged and non-paged memory</td></tr><tr><td>APC_LEVEL</td><td>1, 1, 1</td><td>Asynchronous method calls (APC), or being in this IRQL on page errors, can use most of the kernel APIs and can access paged as well as non-paged memory</td></tr><tr><td>DISPATCH_LEVEL</td><td>2, 2, 2</td><td>Deferred method calls (DPCs) are in this IRQL, can use specific kernel APIs, and can only access non-paged memory</td></tr></tbody></table></div><h3 id=determine-the-current-irql>Determine the current IRQL</h3><ul><li>At the driver entry point DriverEntry, IRQL is PASSIVE_LEVEL, which is guaranteed by the system</li><li>Get the current IRQL by calling KeGetCurrentIrql function</li><li>As shown in the figure, the IRQL are 0, against the above table, the level is PASSIVE_LEVEL</li></ul><p><img src=/posts/windows-kernel-programming-study-notes-001-environment-building/shown3.png width=1160 height=483 srcset="/posts/windows-kernel-programming-study-notes-001-environment-building/shown3_hu12321d81e81434672369422cb952ec6b_98914_480x0_resize_box_3.png 480w, /posts/windows-kernel-programming-study-notes-001-environment-building/shown3_hu12321d81e81434672369422cb952ec6b_98914_1024x0_resize_box_3.png 1024w" loading=lazy alt=rYHLIU.png class=gallery-image data-flex-grow=240 data-flex-basis=576px></p><h3 id=conclusion-1>Conclusion</h3><ul><li>Before calling a certain function first read the function description document and carefully observe what the IRQL level of the safe calling function is, so as to achieve safe programming</li></ul><h2 id=driver-exceptions>Driver exceptions</h2><blockquote><p>When developing a driver, if the driver code is not written in compliance with the situation that triggers a system crash, manifested as a blue screen (BSOD).</p></blockquote><h3 id=common-causes>Common causes</h3><ul><li>High IRQL deadlock</li><li>Memory access violation</li><li>Function stack imbalance</li></ul><h3 id=active-blue-screen-triggered>Active blue screen triggered</h3><ul><li>Blue screen can be triggered proactively using KeBugCheckEx function</li></ul><h3 id=conclusion-2>Conclusion</h3><ul><li>Proactively raising a blue screen in case of unpredictable errors in code can reduce further expansion of the error</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/windows/>Windows</a>
<a href=/tags/kernel/>Kernel</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/windows-kernel-programming-study-notes-002-basic-structure/><div class=article-details><h2 class=article-title>Windows Kernel Programming Study Notes 002 Basic Structure</h2></div></a></article><article><a href=/posts/linux-kernel-programming-study-notes-001-compiling-and-booting-kernel/><div class=article-details><h2 class=article-title>Linux Kernel Programming study notes 001 Compiling and Booting Kernel</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Moeomu/blog data-repo-id=R_kgDOHHJl4A data-category=Announcements data-category-id=DIC_kwDOHHJl4M4CR7uM data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Misaka's Secrect Garden</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>