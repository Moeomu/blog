<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The Windows heap has always been a messy place and managed in a very strange way"><title>Exploit Learning Notes 006 Heap Start</title><link rel=canonical href=https://blog.moeomu.com/posts/exploit-learning-notes-006-heap-start/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Exploit Learning Notes 006 Heap Start"><meta property="og:description" content="The Windows heap has always been a messy place and managed in a very strange way"><meta property="og:url" content="https://blog.moeomu.com/posts/exploit-learning-notes-006-heap-start/"><meta property="og:site_name" content="Misaka's Secrect Garden"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Windows"><meta property="article:tag" content="HeapStructure"><meta property="article:published_time" content="2020-10-20T23:10:00+08:00"><meta property="article:modified_time" content="2020-10-20T23:10:00+08:00"><meta name=twitter:title content="Exploit Learning Notes 006 Heap Start"><meta name=twitter:description content="The Windows heap has always been a messy place and managed in a very strange way"><script async src=https://umami.moeomu.com/Prototype data-website-id=da63d88b-4c19-4ee6-93cc-e12bd941eb81></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu5c4b01d6d06a4818a5284ca6e51e5ac9_24136_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Misaka's Secrect Garden</a></h1><h2 class=site-description>In the gardens embrace, a celestial sprite dances.</h2></div></header><ol class=social-menu><li><a href=https://github.com/Misakaou target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/comment/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>Comment</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://blog.moeomu.com/ selected>English</option><option value=https://blog.moeomu.com/zh-cn/>‰∏≠Êñá</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduction-to-heap>Introduction to heap</a><ol><li><a href=#difference-with-stack>Difference with stack</a></li><li><a href=#heap-safety>Heap safety</a></li><li><a href=#heap-data-structures-and-management-policies>Heap data structures and management policies</a><ol><li><a href=#two-types-of-heap-structures>Two types of heap structures</a></li><li><a href=#management-policy>Management Policy</a></li></ol></li></ol></li><li><a href=#practice>Practice</a><ol><li><a href=#testing-empty-tables>Testing empty tables</a><ol><li><a href=#code>code</a></li><li><a href=#watch>Watch</a></li><li><a href=#conclusion>Conclusion</a></li></ol></li><li><a href=#test-the-fast-table>Test the fast table</a><ol><li><a href=#code-1>code</a></li><li><a href=#conclusion-1>Conclusion</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/exploit/>Exploit</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/exploit-learning-notes-006-heap-start/>Exploit Learning Notes 006 Heap Start</a></h2><h3 class=article-subtitle>The Windows heap has always been a messy place and managed in a very strange way</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 20, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>11 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://blog.moeomu.com/zh-cn/posts/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-006-%E5%A0%86%E7%9A%84%E5%85%A5%E9%97%A8/ class=link>‰∏≠Êñá</a></div></footer></div></header><section class=article-content><p>Disclaimer: The experimental environment is Windows 2000</p><p>Source: <a class=link href=/posts/exploit-learning-notes-006-heap-start/>Moeomu&rsquo;s blog</a></p><h2 id=introduction-to-heap>Introduction to heap</h2><h3 id=difference-with-stack>Difference with stack</h3><ul><li>A heap is a piece of memory space requested from the operating system by the programmer using functions such as malloc. Whether it succeeds or not has a great deal to do with the state of the operating system, unlike the neatly managed stack, its management and allocation algorithm are very peculiar</li><li>The heap is freed by the programmer using free or delete, while the stack is automatically freed by the system.</li><li>The address range of the heap varies greatly, while the memory address of the stack is always <code>0x0012XXXX</code>.</li><li>Heap addresses move from low to high and stack addresses move from high to low</li></ul><h3 id=heap-safety>Heap safety</h3><ul><li>The heap is cluttered, so its use will be much more difficult compared to the stack, and the management of the heap has never been disclosed by Microsoft, so it is difficult to study</li><li>In Windows 2000 - Windows XP SP1, heap management does not take security into account and is easy to exploit</li><li>In Windows XP SP2 - Windows 2003, cookies and pointer validation at the head of the block were added.</li><li>Windows Vista - Windows 7, the security, stability and efficiency of heap management have changed dramatically</li></ul><h3 id=heap-data-structures-and-management-policies>Heap data structures and management policies</h3><h4 id=two-types-of-heap-structures>Two types of heap structures</h4><ul><li>Heap blocks: The memory in the heap area is organized into blocks of different sizes, identified by heap blocks.<ul><li>Block head: the size of this block, whether it is occupied or not</li><li>Block body: data area</li></ul></li><li>Heap table: Located at the beginning of the heap area, it can index all important information about the heap area, including the size, location, and occupancy or not of the heap block. The heap table is often represented by more than one data structure.</li><li>In Windows, heap blocks in the occupied state are only indexed by the program that occupies them, and the heap table only indexes heap blocks in the idle state.</li><li>Important heap tables in Windows.<ul><li>Idle bidirectional linked table: (Freelist) (Empty table)<ul><li>The empty table contains 128 arrays, the second array <code>freelist[1]</code> identifies 8 bytes of empty heap space, after which each item is incremented by 8 bytes one by one</li><li><code>free heap block size (including heap head) = index item * 8(bytes)</code></li><li><code>freelist[0]</code> identifies all heap blocks larger than 1024 bytes (less than or equal to 512KB), which are sorted in ascending order from smallest to largest</li></ul></li><li>Fast one-way linked table (Lookaside) (fast table)<ul><li>The fast table contains 128 entries and is organized similarly to the empty table, but the single-linked table</li><li>Always initialized to null, each fast table has up to 4 nodes</li><li>Each node is initialized as occupied, so no heap block merging occurs</li></ul></li></ul></li></ul><h4 id=management-policy>Management Policy</h4><ul><li>Heap Block Allocation<ul><li>Zero empty table allocation: chaining free blocks of different sizes in ascending order, looking for the last block in reverse from <code>free[0]</code>, and then searching forward for the smallest free heap block that can meet the requirements for allocation</li><li>Ordinary free table allocation: find the best free space allocation, followed by the next best</li><li>Fast table allocation: find the table with matching size, offload it from the heap table, and return a pointer to the heap block to the program</li><li>When the empty table cannot find the optimal heap block, a slightly larger block is used for allocation. This is a suboptimal allocation, where a block is first cut out from the larger block to the exact size requested for allocation, and then the remaining part is relabeled with the block header and concatenated into the empty table.</li><li>The fast table is only allocated when it is an exact match, so there is no such phenomenon</li></ul></li><li>Heap block release<ul><li>Change the heap block status to free and chain to the appropriate heap table. All freed blocks will be chained to the end of the heap table, and the allocation will be taken from the end of the heap table first.</li></ul></li><li>Heap block merge<ul><li>Repeatedly requesting and releasing heap areas will create a lot of memory fragments, so in order to use memory wisely and efficiently some heap blocks will be merged</li><li>This operation consists of unloading two blocks from the free table, merging the heap blocks, adjusting the block head information of the merged block, and re-chaining the new block into the free table.</li><li>The heap area will also undergo a memory crunch (shrink the compact) performed by <code>RtlCompactHeap</code>, which will adjust the entire heap and try to merge the available pieces</li></ul></li><li>Heap block allocation and release strategy<ul><li>Small blocks (SIZE&lt;1KB)<ul><li>Allocation<ul><li>Fast table allocation first, mechanical energy ordinary empty table allocation</li><li>If it fails, use heap cache allocation</li><li>If the heap cache allocation fails, try to allocate after memory crunch</li><li>If allocation is not possible, return NULL</li></ul></li><li>Release<ul><li>Priority chaining to fast table (only 4 free blocks can be chained)</li><li>If the fast table is full, chain to the corresponding empty table</li></ul></li></ul></li><li>Large blocks (1KB&lt;=SIZE&lt;512KB)<ul><li>Allocation<ul><li>Allocate using heap cache</li><li>If the heap cache allocation fails, use the big block in free[0] for allocation</li></ul></li><li>Release<ul><li>Put it into heap cache first</li><li>If heap cache is full, chain into freelists[0]</li></ul></li></ul></li><li>Jumbo block (SIZE>=512KB)<ul><li>Allocation: dummy allocation (not from heap area)</li><li>Release: direct release, no heap table operation</li></ul></li></ul></li></ul><hr><h2 id=practice>Practice</h2><blockquote><p>Lesson learned in blood: whether empty or fast table, its <code>Blink/Flink</code> pointer points to <strong>always</strong> the <code>Blink/Flink</code> of the next/previous node</p></blockquote><h3 id=testing-empty-tables>Testing empty tables</h3><h4 id=code>code</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-CPP data-lang=CPP><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>HLOCAL</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>h4</span><span class=p>,</span> <span class=n>h5</span><span class=p>,</span> <span class=n>h6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>HANDLE</span> <span class=n>hp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>hp</span> <span class=o>=</span> <span class=n>HeapCreate</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mh>0x10000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>__asm</span> <span class=kt>int</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>h1</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h2</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h3</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h4</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h5</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>19</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h6</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>24</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//free block and prevent coaleses
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h1</span><span class=p>);</span> <span class=c1>// free to freelist[2]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h3</span><span class=p>);</span> <span class=c1>// free to freelist[2]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h5</span><span class=p>);</span> <span class=c1>// free to freelist[4]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h4</span><span class=p>);</span> <span class=c1>// coalese h3 h4 h5 link the large block to freelist[8]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=watch>Watch</h4><h5 id=int-exception-calls-up-debugger-not-running>INT exception calls up debugger, not running</h5><ul><li>After <code>HeadCreate()</code> creates the heap area, give the heap area pointer to EAX, and observe that the address is <code>0x360000</code> at this point</li><li>Check the memory area <code>0x360000</code>, the information backward is (copied, I don&rsquo;t know how big these structures are anyway) segment table index (SegmentList), virtual table index (VirtualAllocationList), empty table usage mark (freelist usage bitmap) and empty table index area</li><li>The empty table index is found at offset <code>0x178</code>, and its content is <code>0x00360688</code>, which means <code>freelist[0]</code> points to the offset <code>0x688</code>, let&rsquo;s congratulate what is stored in this place</li><li>This place stores <code>0x00360178</code>, wonderful, it points to <code>freelist[0]</code>, it goes around and points to itself, and this <code>freelist[0]</code> seems to point to the only free heap area, generally known as the &ldquo;tail block&rdquo;</li><li>According to the structure of the heap block (below), the actual block starts at <code>0x00360680</code>, and it looks like the heap block pointer crosses the heap block head and points directly to the data area</li><li><code>0x1-0x2</code> bytes is its own size, at this time the value is <code>0x0130</code>, indicating that the size of the heap is <code>0x130</code> bytes</li><li>The <code>0x3-0x4</code> bytes are the previous heap block size, this value is <code>0x08</code> (?????). Isn&rsquo;t it said to be unique???)</li><li>The <code>0x5</code> byte is the index, which is 0 at this point</li><li><code>0x6</code> byte is Flag, at this point this is 1</li><li><code>0x7</code> byte is reserved byte, which is 0</li><li><code>0x8</code> byte is the tag index (debug state), I don&rsquo;t know what it does, it is 0</li><li><code>0x9-0xC</code> (empty block exclusive) byte is the address of the previous empty block, it is <code>0x00360178</code></li><li>The <code>0xD-0x10</code> (empty heap block exclusive) byte is the address of the next empty heap block, again <code>0x00360178</code></li></ul><h5 id=runs-six-allocations>runs six allocations</h5><ul><li><code>0x00360680-0x00360688</code> is the h1 block header, <code>0x00360689-0x0036068F</code> is the 8 byte block body with <code>00 00 00 00 78 01 36 00</code></li><li><code>0x00360690-0x00360698</code> is the h2 block header, <code>0x00360699-0x0036069F</code> is the 8-byte block body with <code>00 00 00 00 00 01 36 00</code></li><li><code>0x003606A0-0x003606A8</code> is the h3 block header, <code>0x003606A9-0x003606AF</code> is the 8-byte block body with <code>00 00 00 00 00 00 00 36 00</code></li><li><code>0x003606B0-0x003606B8</code> is the h4 block header, <code>0x003606B9-0x003606BF</code> is the 8-byte block body with <code>00 00 00 00 00 00 00 00 00</code></li><li><code>0x003606C0-0x003606C8</code> is the h5 block header, <code>0x003606C9-0x003606DF</code> is a 24 byte block body with `00 00 00 00 00 00 00 00 00 00 00</li><li><code>0x003606E0-0x003606E8</code> is the h5 block header and <code>0x003606E9-0x003606FF</code> is the 24 byte block body with <code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code></li></ul><h5 id=freeing-the-heap>Freeing the heap</h5><ul><li>The first time the heap is freed the block size is 16 bytes, so it is connected to <code>freeList[2]</code>, which is the location of <code>0x188</code>, at this time the content is <code>0x00360688</code></li><li>The second freed heap is also connected to <code>freeList[2]</code>, which is not described in detail</li><li>The third released heap is also connected to <code>freeList[2]</code>, which is not described in detail</li><li>The fourth time it is freed, h3, h4 and h5 are adjacent to each other, so they are merged, where h3h4 is 2 heap units each and h5 is 4, so they are merged to a total of 8 heap units, excluding the heap head, they are left with 7 heap units, so they are put into <code>freeList[8]</code></li></ul><h4 id=conclusion>Conclusion</h4><ul><li>The information contained in the heap table is SegmentList, VirtualAllocationList, freelist usage bitmap and empty index area in that order.</li><li>When a heap is just initialized, its heap block status<ul><li>There is only one large block in the idle state, which is called the &ldquo;tail block&rdquo;</li><li>This is followed by the fast table</li><li>Freelist[0] points to the &ldquo;tail block&rdquo;</li><li>Each index of the region points to itself, except for the zero freelist index, which means that there are no free blocks in all the rest of the free-table</li></ul></li><li>First occupied block</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-CPP data-lang=CPP><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Flag</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>Busy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>ExtraPresent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FillPattern</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>VirtualAlloc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>LastEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FFU1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FFU2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>NoCoalesce</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>BusyHeapHeadBlock</span>
</span></span><span class=line><span class=cl><span class=c1>// 8 Byte Head
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>USHORT</span> <span class=n>SelfSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>USHORT</span> <span class=n>PreviousChunkSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCHAR</span> <span class=n>SegmentIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>Flag</span> <span class=n>Flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCAHR</span> <span class=n>UnusedBytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCAHR</span> <span class=n>TagIndex_Debug</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Data After...
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Idle state block head</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-CPP data-lang=CPP><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Flag</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>Busy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>ExtraPresent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FillPattern</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>VirtualAlloc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>LastEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FFU1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>FFU2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>BIT</span> <span class=n>NoCoalesce</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>BusyHeapHeadBlock</span>
</span></span><span class=line><span class=cl><span class=c1>// 16 Byte Head
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>USHORT</span> <span class=n>SelfSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>USHORT</span> <span class=n>PreviousChunkSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCHAR</span> <span class=n>SegmentIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>Flag</span> <span class=n>Flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCAHR</span> <span class=n>UnusedBytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>UCAHR</span> <span class=n>TagIndex_Debug</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>PVOID</span> <span class=n>FlinkInFreelist</span><span class=p>;</span> <span class=c1>// ‰∏ã‰∏Ä‰∏™
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>PVOID</span> <span class=n>BlinkInFreelist</span><span class=p>;</span> <span class=c1>// ‰∏ä‰∏Ä‰∏™
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Empty Data After...
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Heap block allocation<ul><li>The size of the heap block includes the block header, so the application for 32 bytes will allocate 40 bytes.</li><li>The unit of heap block is 8 bytes, less than 8 bytes are allocated according to 8 bytes, so the minimum actual allocation is 16 bytes</li><li>In the initial state, the fast table and the empty table are empty, there is no exact allocation, the request will be allocated using the suboptimal block</li><li>Due to the occurrence of suboptimal allocation, the allocation function will cut away some small blocks from the tail block, modify the size at the beginning of the tail block, and finally point <code>freelist[0]</code> to the new tail block</li></ul></li></ul><h3 id=test-the-fast-table>Test the fast table</h3><h4 id=code-1>code</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-CPP data-lang=CPP><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>HLOCAL</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>h4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>HANDLE</span> <span class=n>hp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>hp</span> <span class=o>=</span> <span class=n>HeapCreate</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>__asm</span> <span class=kt>int</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=n>h1</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h2</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h3</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h4</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>24</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>h2</span> <span class=o>=</span> <span class=n>HeapAlloc</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>HeapFree</span><span class=p>(</span><span class=n>hp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>h2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=conclusion-1>Conclusion</h4><ul><li>The block first identification bit is 0x01</li><li>Only the pointer to the next block in the stack is stored, there is no pointer to the previous block in the stack</li><li>The address of <code>freeList[0]</code> at offset <code>0x178</code> becomes <code>0x00361E90</code> and the original <code>0x00360688</code> is occupied by the fast table</li><li>The fast table starts at <code>0x688</code>, each structure has a total of <code>0x30</code> bytes, and the first four bytes of content are the fast table chain</li><li>Although the 0Day security book says that the 8-byte heap area is inserted as <code>lookaside[1]</code>, it seems to me that it is the one at <code>0x688</code> that is <code>lookaside[0]</code>, the one at <code>0x6B8</code> that is <code>lookaside[1]</code>, and the one at <code>0x0E8</code> that can be called <code>lookaside[2]</code>, which The size of the heap block with the block header is 16 bytes in total</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/windows/>Windows</a>
<a href=/tags/heapstructure/>HeapStructure</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/exploit-learning-notes-021-protected-heap/><div class=article-details><h2 class=article-title>Exploit learning notes 021 Protected HEAP</h2></div></a></article><article><a href=/posts/exploit-learning-notes-020-sehop-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 020 SEHOP introduction</h2></div></a></article><article><a href=/posts/exploit-learning-notes-019-using-heapspray-attack-aslr/><div class=article-details><h2 class=article-title>Exploit learning notes 019 Using HeapSpray Attack ASLR</h2></div></a></article><article><a href=/posts/exploit-learning-notes-018-using-partial-overlay-location/><div class=article-details><h2 class=article-title>Exploit learning notes 018 using partial overlay location</h2></div></a></article><article><a href=/posts/exploit-learning-notes-017-aslr-introduction/><div class=article-details><h2 class=article-title>Exploit learning notes 017 ASLR Introduction</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Moeomu/blog data-repo-id=R_kgDOHHJl4A data-category=Announcements data-category-id=DIC_kwDOHHJl4M4CR7uM data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Misaka's Secrect Garden</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>